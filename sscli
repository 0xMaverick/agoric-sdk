#! /bin/sh
test -t 1 && FLAGS=-t
thisdir=`dirname "$0"`
ABS=`cd "$thisdir" && pwd`
COSSD_PORT=26657
REST_PORT=1317
ENTRY=./sscli
ARGS=


case "$1" in
keys | help | config)
  # No need for networking to ssd, indeed, SSH interaction
  # would mess up our output.
  ;;
*)
  case " $@ " in
  *" --help "*) ;;
  *)
    if test `uname -s 2>/dev/null` = Darwin; then
      # On MacOS, run the tunnel to host.docker.internal:$COSSD_PORT.
      # FIXME: Windows needs the same.
      ENTRY=/ssh-tunnel
      FLAGS="-t --volume=$HOME/.ssh:/root/.ssh" # --volume=$ABS/ssh-tunnel:/ssh-tunnel"
      ARGS=" $USER@host.docker.internal $COSSD_PORT ./sscli"
    fi
    ;;
  esac
  ;;
esac

case "$1" in
rest-server)
  FLAGS="$FLAGS -p127.0.0.1:$REST_PORT:$REST_PORT"
  ;;
esac

exec docker run -i $FLAGS --entrypoint="$ENTRY" \
  --volume=sscli-state:/root/.sscli \
  --rm agoric/cosmic-swingset$ARGS ${1+"$@"}
