#!/usr/bin/env node

const process = require('process');
const repl = require('repl');
require = require('esm')(module);

const { loadBasedir, buildVatController } = require('../src/index.js');

async function main() {
  let argv = process.argv.splice(2);
  let withSES = true;
  if (argv[0] === '--no-ses') {
    withSES = false;
    argv.shift();
  }
  const basedir = (argv[0] === '--' || argv[0] === undefined) ? '.' : argv.shift();
  const vatArgv = argv[0] === '--' ? argv.slice(1) : argv;

  const config = await loadBasedir(basedir);
  const controller = await buildVatController(config, withSES, vatArgv);
  const r = repl.start({ prompt: 'vat> ',
                         replMode: repl.REPL_MODE_STRICT,
                       });
  r.context.dump = () => console.log(controller.dump());
  r.context.run = () => {console.log('run!'); controller.run();};
  r.context.step = () => {console.log('step!'); controller.step();};

}

main();

